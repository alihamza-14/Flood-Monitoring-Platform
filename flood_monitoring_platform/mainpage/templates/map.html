<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flood Monitoring Portal</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
  <style>
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background-color: #333;
      overflow-x: hidden;
      transition: 0.5s;
      width: 60px;
      padding-top: 20px;
    } 

    #sidebar.expanded {
      width: 250px;
    }
    #sidebar .toggle-btn {
      display: block;
      text-align: center;
      padding: 20px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
    }
    #sidebar .sidebar-content {
      display: none;
      padding: 16px;
      color: white;
    }
    #sidebar.expanded .sidebar-content {
      display: block;
    }
    #sidebar .sidebar-content a {
      text-decoration: none;
      color: white;
      display: block;
      padding: 10px 16px;
      transition: 0.3s;
      font-family: 'Verdana', sans-serif;
      font-size: 16px;
    }
    #start-animation {
      display: block;
      padding: 10px 20px;
      margin: 5px 0;
      background: #3d8b40;
      text-align: center;
      color: white;
      border: none;
      {% comment %} border-radius: 3px; {% endcomment %}
      cursor: pointer;
    }
    #sidebar .sidebar-content a:hover,
    #start-animation:hover  {
      background-color: #575757;
    }
    #sidebar .sidebar-content a.active {
      background-color: #444;
    }
    .dropdown-content {
      display: none;
      padding-left: 25px;
    }
    .dropdown-content label {
      display: block;
      margin: 5px 0;
      font-family: Arial, sans-serif;
      font-size: 14.5px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <div class="toggle-btn" onclick="toggleSidebar()">â˜°</div>
    <div class="sidebar-content">
      <button id="start-animation">Start Animation</button>
      <br>
      <br>
      <a href="#" onclick="toggleAdminBoundary(this)">Administrative Boundary</a>
      <a href="#" onclick="toggleNHARoadNetwork(this)">NHA Road Network</a>
      <div class="dropdown">
        <a href="#" onclick="toggleDropdown(this, 'floodDropdown')">Flood Extents</a>
        <div id="floodDropdown" class="dropdown-content">
          <label>
            <input type="checkbox" class="toggleLayer" data-layer="june"> June
          </label>
          <label>
            <input type="checkbox" class="toggleLayer" data-layer="july"> July
          </label>
          <label>
            <input type="checkbox" class="toggleLayer" data-layer="august"> August
          </label>
          <label>
            <input type="checkbox" class="toggleLayer" data-layer="september"> September
          </label>
        </div>
      </div>
      <div class="dropdown">
        <a href="#" onclick="toggleDropdown(this, 'roadDropdown')">Roads</a>
        <div id="roadDropdown" class="dropdown-content">
          <label>
            <input type="checkbox" class="toggleRoadLayer" data-month="june"> June
          </label>
          <label>
            <input type="checkbox" class="toggleRoadLayer" data-month="july"> July
          </label>
          <label>
            <input type="checkbox" class="toggleRoadLayer" data-month="august"> August
          </label>
          <label>
            <input type="checkbox" class="toggleRoadLayer" data-month="september"> September
          </label>
        </div>
      </div>
      <div class="dropdown">
        <a href="#" onclick="toggleDropdown(this, 'airportDropdown')">Airports</a>
        <div id="airportDropdown" class="dropdown-content">
          <label>
            <input type="checkbox" class="toggleAirportLayer" data-month="june"> June
          </label>
          <label>
            <input type="checkbox" class="toggleAirportLayer" data-month="july"> July
          </label>
          <label>
            <input type="checkbox" class="toggleAirportLayer" data-month="august"> August
          </label>
          <label>
            <input type="checkbox" class="toggleAirportLayer" data-month="september"> September
          </label>
        </div>
      </div>
      <div class="dropdown">
        <a href="#" onclick="toggleDropdown(this, 'settlementDropdown')">Settlements</a>
        <div id="settlementDropdown" class="dropdown-content">
          <label>
            <input type="checkbox" class="toggleSettlementLayer" data-month="june"> June
          </label>
          <label>
            <input type="checkbox" class="toggleSettlementLayer" data-month="july"> July
          </label>
          <label>
            <input type="checkbox" class="toggleSettlementLayer" data-month="august"> August
          </label>
          <label>
            <input type="checkbox" class="toggleSettlementLayer" data-month="september"> September
          </label>
        </div>
      </div>
      
      <div class="dropdown">
        <a href="#" onclick="toggleDropdown(this, 'healthDropdown')">Health</a>
        <div id="healthDropdown" class="dropdown-content">
          <label>
            <input type="checkbox" class="toggleHealthLayer" data-month="june"> June
          </label>
          <label>
            <input type="checkbox" class="toggleHealthLayer" data-month="july"> July
          </label>
          <label>
            <input type="checkbox" class="toggleHealthLayer" data-month="august"> August
          </label>
          <label>
            <input type="checkbox" class="toggleHealthLayer" data-month="september"> September
          </label>
        </div>
      </div>
      <div class="dropdown">
        <a href="#" onclick="toggleDropdown(this, 'schoolDropdown')">Schools</a>
        <div id="schoolDropdown" class="dropdown-content">
          <label>
            <input type="checkbox" class="toggleSchoolLayer" data-month="june"> June
          </label>
          <label>
            <input type="checkbox" class="toggleSchoolLayer" data-month="july"> July
          </label>
          <label>
            <input type="checkbox" class="toggleSchoolLayer" data-month="august"> August
          </label>
          <label>
            <input type="checkbox" class="toggleSchoolLayer" data-month="september"> September
          </label>
        </div>
      </div>      
    </div>
  </div>
  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoiYWxpaGFtemEtMTQiLCJhIjoiY2x4dHkzdHJ6MWhzOTJrcXdqcnFsYnU4dyJ9.LbRvUbNnNk2rUq13y-8gFQ";
    const map = new mapboxgl.Map({
      container: "map",
      style: 'mapbox://styles/mapbox/light-v11',
      center: [74.237, 34.735], // initial center [lng, lat]
     // center: [69.3451, 30.3753],
      zoom: 6
    });

    const cameraPositions = [
    { center: [74.237, 34.735], zoom: 6 }, // Kashmir
    { center: [60.395, 23.080], zoom: 6 }, // Karachi
    { center: [74.237, 34.735], zoom: 6 }  // Kashmir
    ];

let currentIndex = 0;
let animationInterval;

{% comment %} function animateCamera() {
  const startPosition = cameraPositions[currentIndex];
  const endPosition = cameraPositions[(currentIndex + 1) % cameraPositions.length];
  const steps = 100;
  let step = 0;

  function move() {
      if (step <= steps) {
          const lng = startPosition[0] + (endPosition[0] - startPosition[0]) * (step / steps);
          const lat = startPosition[1] + (endPosition[1] - startPosition[1]) * (step / steps);
          map.easeTo({
              center: [lng, lat],
              zoom: 6,
              speed: 0.2,
              curve: 1
          });
          step++;
          animationFrame = requestAnimationFrame(move);
      } else {
          currentIndex = (currentIndex + 1) % cameraPositions.length;
          step = 0;
          animateCamera();
      }
  }

  move();
} {% endcomment %}
  function animateCamera() {
    const position = cameraPositions[currentIndex];
    map.flyTo({
        center: position.center,
        zoom: position.zoom,
        speed: 0.12, // make the flying slow
        curve: 1,  // change the speed at which it zooms out
        easing(t) {
            return t;
        }
    });

    currentIndex = (currentIndex + 1) % cameraPositions.length;
  } 
    const extentColors = {
      june: "#D0C73E", // Yellow
      july: "#271ABC", // Dark Blue
      august: "#ff7f0e", // Orange
      september: "#d62728" // Red
    };
    
    const airportColors = {
      june: "#9467bd", // Purple
      july: "#8c564b", // Brown
      august: "#e377c2", // Pink
      september: "#7f7f7f" // Grey
    };

    const healthColors = {
      june: "#1f77b4", // Light Blue
      july: "#ff7f0e", // Orange
      august: "#2ca02c", // Green
      september: "#d62728" // Red
    };
    
    const roadColors = {
      june: "#8B4513", // SaddleBrown
      july: "#FF4500", // OrangeRed
      august: "#32CD32", // LimeGreen
      september: "#4682B4" // SteelBlue
    };
 
    const settlementColors = {
      june: "#FF4500", // Orange Red
      july: "#2E8B57", // Sea Green
      august: "#4682B4", // Steel Blue
      september: "#D2691E" // Chocolate
    };
    
    const schoolColors = {
      june: "#3B3B6D", // Dark Blue
      july: "#DAA520", // Goldenrod
      august: "#FF6347", // Tomato
      september: "#8A2BE2" // Blue Violet
    };
    
    function addAdminBoundary() {
      fetch("http://127.0.0.1:8000/pakistan_admin_boundary/")
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });

          map.addSource("pakistan_admin_boundary", {
            type: "geojson",
            data: data
          });

          map.addLayer({
            id: "pakistan_admin_boundary",
            type: "line",
            source: "pakistan_admin_boundary",
            layout: {},
            paint: {
              "line-color": "#1C580B", // Dark Green
              "line-width": 3
            }
          });
        });
    }

    function addNHARoadNetwork() {
      fetch("http://127.0.0.1:8000/nha_road_network/")
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });

          map.addSource("nha_road_network", {
            type: "geojson",
            data: data
          });

          map.addLayer({
            id: "nha_road_network",
            type: "line",
            source: "nha_road_network",
            layout: {},
            paint: {
              "line-color": "#800A02", // Red
              "line-width": 1.5
            }
          });
        });
    }

    function addFloodExtent(layerName) {
      fetch(`http://127.0.0.1:8000/flood_extent/?month=${layerName}`)
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });

          map.addSource(`${layerName}_flood_extent`, {
            type: "geojson",
            data: data
          });

          map.addLayer({
            id: `${layerName}_flood_extent`,
            type: "fill",
            source: `${layerName}_flood_extent`,
            layout: {},
            paint: {
              "fill-color": extentColors[layerName],
              "fill-opacity": 0.75
            }
          });
        });
    }

    function addRoad(month) {
      fetch(`http://127.0.0.1:8000/road/?month=${month}`)
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });
    
          map.addSource(`${month}_road`, {
            type: "geojson",
            data: data
          });
    
          map.addLayer({
            id: `${month}_road`,
            type: "line",
            source: `${month}_road`,
            paint: {
              "line-color": roadColors[month],
              "line-width": 1
            }
          });
        });
    }
    
    function addAirport(month) {
      fetch(`http://127.0.0.1:8000/airport/?month=${month}`)
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });

          map.addSource(`${month}_airport`, {
            type: "geojson",
            data: data
          });

          map.addLayer({
            id: `${month}_airport`,
            type: "circle",
            source: `${month}_airport`,
            paint: {
              "circle-color": airportColors[month],
              "circle-radius": 5,
              "circle-stroke-width": 1,
              "circle-stroke-color": "#ffffff"
            }
          });
        });
    }

    function addHealth(month) {
      fetch(`http://127.0.0.1:8000/health/?month=${month}`)
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });

          map.addSource(`${month}_health`, {
            type: "geojson",
            data: data
          });

          map.addLayer({
            id: `${month}_health`,
            type: "circle",
            source: `${month}_health`,
            paint: {
              "circle-color": healthColors[month],
              "circle-radius": 4,
              "circle-stroke-width": 1,
              "circle-stroke-color": "#ffffff"
            }
          });
        });
    }
 
    function addSettlement(month) {
      fetch(`http://127.0.0.1:8000/settlement/?month=${month}`)
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });
    
          map.addSource(`${month}_settlement`, {
            type: "geojson",
            data: data
          });
    
          map.addLayer({
            id: `${month}_settlement`,
            type: "circle",
            source: `${month}_settlement`,
            paint: {
              "circle-color": settlementColors[month],
              "circle-radius": 3,
              "circle-stroke-width": 1,
              "circle-stroke-color": "#ffffff"
            }
          });
        });
    }

    function addSchool(month) {
      fetch(`http://127.0.0.1:8000/school/?month=${month}`)
        .then(response => response.json())
        .then(data => {
          data.features.forEach(feature => {
            if (typeof feature.geometry === "string") {
              feature.geometry = JSON.parse(feature.geometry);
            }
          });
    
          map.addSource(`${month}_school`, {
            type: "geojson",
            data: data
          });
    
          map.addLayer({
            id: `${month}_school`,
            type: "circle",
            source: `${month}_school`,
            paint: {
              "circle-color": schoolColors[month],
              "circle-radius": 2,
              "circle-stroke-width": 1,
              "circle-stroke-color": "#ffffff"
            }
          });
        });
    }
    
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle('expanded');
    }

    function toggleDropdown(button, dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      const isActive = dropdown.style.display === "block";
      
      // Close all dropdowns first
      document.querySelectorAll('.dropdown-content').forEach(d => {
        d.style.display = 'none';
      });
      document.querySelectorAll('.dropdown a').forEach(a => {
        a.classList.remove('active');
      });

      // Toggle the selected dropdown
      dropdown.style.display = isActive ? "none" : "block";
      button.classList.toggle('active', !isActive);
    }

    function toggleAdminBoundary(button) {
      const isActive = button.classList.toggle('active');
      if (isActive) {
        addAdminBoundary();
      } else {
        map.removeLayer('pakistan_admin_boundary');
        map.removeSource('pakistan_admin_boundary');
      }
    }

    function toggleNHARoadNetwork(button) {
      const isActive = button.classList.toggle('active');
      if (isActive) {
        addNHARoadNetwork();
      } else {
        map.removeLayer('nha_road_network');
        map.removeSource('nha_road_network');
      }
    }

    document.querySelectorAll('.toggleLayer').forEach(item => {
      item.addEventListener('change', event => {
        const layerName = event.target.getAttribute('data-layer');
        if (event.target.checked) {
          addFloodExtent(layerName);
        } else {
          map.removeLayer(`${layerName}_flood_extent`);
          map.removeSource(`${layerName}_flood_extent`);
        }
      });
    });

    document.querySelectorAll('.toggleAirportLayer').forEach(item => {
      item.addEventListener('change', event => {
        const month = event.target.getAttribute('data-month');
        if (event.target.checked) {
          addAirport(month);
        } else {
          map.removeLayer(`${month}_airport`);
          map.removeSource(`${month}_airport`);
        }
      });
    });

    document.querySelectorAll('.toggleHealthLayer').forEach(item => {
      item.addEventListener('change', event => {
        const month = event.target.getAttribute('data-month');
        if (event.target.checked) {
          addHealth(month);
        } else {
          map.removeLayer(`${month}_health`);
          map.removeSource(`${month}_health`);
        }
      });
    });

    document.querySelectorAll('.toggleRoadLayer').forEach(item => {
      item.addEventListener('change', event => {
        const month = event.target.getAttribute('data-month');
        if (event.target.checked) {
          addRoad(month);
        } else {
          map.removeLayer(`${month}_road`);
          map.removeSource(`${month}_road`);
        }
      });
    });

    document.querySelectorAll('.toggleSettlementLayer').forEach(item => {
      item.addEventListener('change', event => {
        const month = event.target.getAttribute('data-month');
        if (event.target.checked) {
          addSettlement(month);
        } else {
          map.removeLayer(`${month}_settlement`);
          map.removeSource(`${month}_settlement`);
        }
      });
    });

    document.querySelectorAll('.toggleSchoolLayer').forEach(item => {
      item.addEventListener('change', event => {
        const month = event.target.getAttribute('data-month');
        if (event.target.checked) {
          addSchool(month);
        } else {
          map.removeLayer(`${month}_school`);
          map.removeSource(`${month}_school`);
        }
      });
    });

    document.getElementById('start-animation').addEventListener('click', () => {
      if (animationInterval) {
          clearInterval(animationInterval);
      }
      animateCamera(); // Start the first animation immediately
      animationInterval = setInterval(animateCamera, 6000); // Adjust the time interval as needed
    }); 
   
  </script>
</body>
</html>
